name: Hull-White-Model-for-Zero-Coupon-Bonds-and-Sensitivity-Analysis-CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  

env:
  CUDA_VERSION: "11.8.0"
  PYTHON_VERSION: "3.10"

jobs:
  # Job 1: Build and compile all CUDA executables
  build:
    name: Build CUDA Executables
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:11.8.0-devel-ubuntu22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install build dependencies
      run: |
        apt-get update
        apt-get install -y make g++
    
    - name: Create build directories
      run: |
        mkdir -p bin data plots
    
    - name: Build Q1 (Bond Pricing)
      run: |
        nvcc -O3 --use_fast_math -arch=sm_70 -lcurand \
          -I include src/1_bond_pricing.cu -o bin/q1
    
    - name: Build Q2 (Option Pricing)
      run: |
        nvcc -O3 --use_fast_math -arch=sm_70 -lcurand \
          -I include src/2_option_pricing.cu -o bin/q2
    
    - name: Build Q3 (Sensitivity Analysis)
      run: |
        nvcc -O3 --use_fast_math -arch=sm_70 -lcurand \
          -I include src/3_sensitivity_analysis.cu -o bin/q3
    
    - name: Build Benchmark
      run: |
        nvcc -O3 --use_fast_math -arch=sm_70 -lcurand \
          -I include src/benchmark_reductions.cu -o bin/benchmark
    
    - name: Verify executables
      run: |
        ls -lh bin/
        echo "All executables built successfully!"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: cuda-executables
        path: bin/
        retention-days: 7

  # Job 2: Code quality and linting
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for CUDA syntax issues
      run: |
        echo "Checking for common CUDA patterns..."
        # Check for potential race conditions
        ! grep -rn "atomicAdd.*atomicAdd" src/ include/ || \
          (echo "Warning: Multiple atomicAdd in same context" && exit 1)
        
        # Check for proper error handling
        grep -rn "check_cuda" src/ | wc -l > /tmp/checks.txt
        echo "Found $(cat /tmp/checks.txt) CUDA error checks"
    
    - name: Check code formatting
      run: |
        echo "Checking for consistent formatting..."
        # Basic checks for code style
        ! grep -rn "TODO\|FIXME\|XXX" src/ include/ || echo "Found TODOs"
    
    - name: Verify file structure
      run: |
        test -f README.md || exit 1
        test -f makefile || exit 1
        test -d include || exit 1
        test -d src || exit 1
        echo "File structure verified ✓"

  # Job 3: Documentation validation
  docs:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check README completeness
      run: |
        echo "Validating README.md..."
        grep -q "## Results" README.md || exit 1
        grep -q "## Mathematical Model" README.md || exit 1
        grep -q "## Implementation" README.md || exit 1
        grep -q "## Building & Running" README.md || exit 1
        echo "README structure verified ✓"
    
    - name: Check code comments
      run: |
        echo "Checking for inline documentation..."
        comment_lines=$(grep -r "^[[:space:]]*//\|^[[:space:]]*/\*" src/ include/ | wc -l)
        total_lines=$(find src/ include/ -name "*.cu" -o -name "*.cuh" | xargs wc -l | tail -1 | awk '{print $1}')
        ratio=$((comment_lines * 100 / total_lines))
        echo "Comment ratio: ${ratio}%"
        test $ratio -ge 10 || echo "Warning: Low comment ratio"

  # Job 4: Python analysis tools validation
  validate-analysis:
    name: Validate Analysis Scripts
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install numpy matplotlib pandas
    
    - name: Check Python syntax
      run: |
        python -m py_compile analyze.py
        echo "Python syntax check passed ✓"
    
    - name: Verify plot functions
      run: |
        cat > check_functions.py << 'EOF'
        import sys
        import importlib.util
        
        spec = importlib.util.spec_from_file_location('analyze', 'analyze.py')
        analyze = importlib.util.module_from_spec(spec)
        spec.loader.exec_module(analyze)
        
        functions = [
            'plot_paths_static',
            'plot_P_and_f', 
            'plot_theta_recovery',
            'plot_sensitivity_comparison',
            'plot_reduction_benchmark',
            'print_summary'
        ]
        
        for func in functions:
            if not hasattr(analyze, func):
                print(f'Missing function: {func}')
                sys.exit(1)
        
        print('All required functions found ✓')
        EOF
        python3 check_functions.py

  # Job 5: Create summary report
  report:
    name: Generate CI Report
    runs-on: ubuntu-latest
    needs: [build, lint, docs, validate-analysis]
    if: always()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate build summary
      run: |
        echo "# CI Pipeline Summary" > $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Build Status" >> $GITHUB_STEP_SUMMARY
        echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Lint: ${{ needs.lint.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation: ${{ needs.docs.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Analysis Tools: ${{ needs.validate-analysis.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Project Info" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Comment on PR (if applicable)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'CI Pipeline completed. All CUDA kernels compiled successfully.'
          })